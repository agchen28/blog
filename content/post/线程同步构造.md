---
date: 2017-01-25T11:13:00+08:00
draft: false
tags: ["dotnet"]
categories: ["技术相关"]
title: 线程同步构造
---
这个主题涉及内容太多，只能先简单介绍一下。  
线程同步构造就是我们俗话说的锁。  
锁的作用就是确保一次只有一个线程访问资源。  
为什么需要锁呢？  
多个线程同时访问共享数据时（必须是共享数据，还有同时访问），锁能防止数据损坏。当然多个线程对共享数据进行只读访问是没有任何问题的。  
锁的使用一定是要不得已而为之，因为它有很多缺点。比如影响性能，增加复杂性，还容易出问题。

##  基元线程同步构造
基元指可以在代码中使用的最简单构造。  
有两种基元构造：用户模式（useÏr-mode）和内核模式（kernel-mode）。  
### 用户模式构造
应尽量使用用户模式构造，它们的速度显著快于内核模式的构造。  
特点：  
使用特殊的CPU指令来协调线程，意味着协调是在硬件中发生的，也意味着操作系统不知道一个线程在用户模式构造中阻塞了，由于操作系统不认为它已经被阻塞了，所以线程池不会创建新线程来替换这种临时阻塞的线程。  
这些CPU指令只阻塞线程相当短的时间。  
缺点：  
想要取得资源但暂时取不到的线程会一直在用户模式中“自旋”，这会浪费CPU时间。  

有两种基元用户模式线程同步构造：  

- 易变构造（volatile construct）  
在特定的时间，它在包含一个简单数据类型的变量上执行原子性的读或写操作。

- 互锁构造（interlocked construct）  
在特定的时间，它在包含一个简单数据类型的变量上执行原子性的读和写操作。

### 内核模式构造
内核模式构造比用户模式构造慢得多，需要操作系统的配合。  
优点：  
操作系统知道一个线程是否在内核模式构造上阻塞了。  
可以实现本机和托管线程相互之间的同步。  
可以同步一个机器的不同进程中的线程。  

## 混合线程同步构造

所有的线程同步构造都是基于用户模式构造和内核模式构造所构建的，混合了这两种构造的就称为混合线程同步构造。  
混合线程同步构造一般结合了这两种线程同步构造的优点，即在没有线程竞争时，混合构造提供了基元用户模式构造的性能优势；当出现线程竞争时，又具备内核模式构造不“自旋”的优势（不浪费cpu时间）。  
这里面有个最重要的，也是我们最常用的Monitor，可能大家对这名字还是比较陌生，但是它就是我们平时用得最多的lock。