---
date: 2017-01-03T21:52:01+08:00
draft: true
title: 程序执行过程
tags: [".NET基础","CSharp"]
categories: ["技术相关"]
---

简单地理一下.NET程序的执行过程。
### 将源代码编译成托管模块
先了解几个概念：

* 托管模块(managed module)：包含头信息，元数据和IL代码。
* CLR(common language runtime):公共语言运行时，由多种编程语言使用的“运行时”。（运行时三个字实在抽象）简单理解为：介于操作系统与托管应用程序之间，管理托管程序的执行。
* CLR核心功能：内存管理，程序集加载，安全性，异常处理和线程同步。

不管哪种语言编写的源代码文件，经过面向该语言的编译器编译后，结果都是托管模块。事实上，在运行时，CLR根本不关心开发人员用哪一种语言编写源代码。  
微软提供的面向CLR的语言编译器有：C++/CLI、C#、VB、F#等，还有一个IL汇编器（ILAsm.exe）。  
第三方的有：PHP、Lua、Perl、Smalltalk等等非常多，很可能一辈子都用不上的东西。  
简单介绍一下托管模块中的两个重要组成部分：

* 元数据。描述源代码中定义和引用的类型和成员。
* IL代码。托管给CLR执行的代码。运行时，CLR将IL编译成本机CPU指令。

### 将托管模块合并成程序集
对于只有一个托管模块而且无资源文件的项目，编译器生成含有清单的托管模块，也就是程序集。这一过程无需执行额外的步骤。  
还可以将一组文件合并到程序集中，需要用到程序集链接器——AL.exe。

### 加载公共语言运行时
* Windows检查EXE文件头，决定是创建32位还是64位进程之后，会在进程地址空间加载MSCorEE.dll的x86，x64或ARM版本。
* 进程的主线程调用MSCorEE.dll中定义的一个方法。这个方法初始化CLR。
* 接着CLR加载EXE程序集，调用程序入口方法（Main），随即托管程序启动并运行。
